{"version":3,"file":"cloudpoodll.min.js","sources":["../src/cloudpoodll.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * The CloudPoodll JS for loading recorders into iframe based on data-attributes on the container div\n *\n * @module     mod_solo/cloudpoodll\n * @copyright  2025 Justin Hunt <justin@poodll.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([], function () {\n\n    return {\n        version: '1.3.4',\n        baseURL: 'https://cloud.poodll.com/local/cpapi/fastpoodllloader.php',\n        params: ['parent', 'appid', 'timelimit', 'type', 'media', 'updatecontrol', 'width', 'height', 'id',\n            'iframeclass', 'transcode', 'transcoder', 'transcribe', 'subtitle', 'language', 'transcribevocab',\n            'expiredays', 'owner', 'region', 'token', 'localloader', 'localloading', 'notificationurl',\n            'sourcemimetype', 'speechevents', 'hints', 'alreadyparsed', 'fallback', 'cloudpoodllurl'],\n\n        setBaseUrl: function (cloudpoodllurl) {\n            this.baseURL = cloudpoodllurl + '/local/cpapi/fastpoodllloader.php';\n        },\n\n        fetchContainers: function (classname) {\n            var divs = document.getElementsByClassName(classname);\n            return divs;\n        },\n        autoCreateRecorders: function (classname) {\n            if (!classname) { classname = 'cloudpoodll'; }\n            var containers = this.fetchContainers(classname);\n            for (var ctr = 0; ctr < containers.length; ctr++) {\n                this.insertRecorder(containers[ctr]);\n            }\n        },\n        createRecorder: function (elementid) {\n            var theelement = document.getElementById(elementid);\n            this.insertRecorder(theelement);\n        },\n\n        insertRecorder: function (container, attributes) {\n            if (attributes == undefined) {\n                attributes = this.parseAttributes(container);\n            }\n            var iframe = this.createIframe(attributes);\n            if (iframe) {\n                container.appendChild(iframe);\n                container.setAttribute('data-alreadyparsed', 'true');\n            }\n        },\n        parseAttributes: function (container) {\n            var attributes = {};\n            for (var i = 0; i < this.params.length; i++) {\n                var attr = container.getAttribute('data-' + this.params[i]);\n                if (attr !== null) {\n                    attributes[this.params[i]] = attr;\n                }\n            }\n            return attributes;\n        },\n        createIframe: function (attributes) {\n\n            //cancel out if this div was already processed\n            if (attributes.hasOwnProperty('alreadyparsed')) {\n                if (attributes['alreadyparsed'] == 'true') {\n                    // console.log(\"Can only parse a cloudpoodll element once. Cancelling.\");\n                    return false;\n                }\n            }\n\n            //CloudPoodllURL\n            if (attributes.hasOwnProperty('cloudpoodllurl')) {\n                this.setBaseUrl(attributes['cloudpoodllurl']);\n            }\n\n            //fix up default attributes if the user did not set them\n            //parent\n            if (!attributes.hasOwnProperty('parent')) {\n                attributes['parent'] = window.location.protocol + '//' + window.location.hostname;\n            }\n            //media\n            if (!attributes.hasOwnProperty('media')) {\n                attributes['media'] = 'audio';\n            }\n            //also store predicted mimetype\n            attributes['sourcemimetype'] = this.guess_mimetype(attributes['media'], attributes['transcribe'], attributes['hints']);\n\n            //build and set the iframe src url\n            var iframe = document.createElement('iframe');\n\n            //set up the base URL for the iframe\n            //if we need and can load locally from html we do that\n            if (!attributes.hasOwnProperty('localloader')) {\n                var localloading = 'never';\n            } else {\n                var localloading = attributes.hasOwnProperty('localloading') ? attributes['localloading'] : 'auto';\n            }\n\n            switch (localloading) {\n\n                case 'always':\n                    var iframeurl = attributes['parent'] + attributes['localloader'] +\n                        '?cloudpoodllurl=' + attributes['cloudpoodllurl'] + '&';\n                    break;\n\n                case 'never':\n                    var iframeurl = this.baseURL + '?';\n                    break;\n\n                case 'auto':\n                default:\n                    var isIOS_safari = this.is_ios() || this.is_safari();\n                    if (isIOS_safari) {\n                        var iframeurl = attributes['parent'] + attributes['localloader'] +\n                            '?cloudpoodllurl=' + attributes['cloudpoodllurl'] + '&';\n                    } else {\n                        var iframeurl = this.baseURL + '?';\n                    }\n                    break;\n            }\n\n            //build iframeurl based on baseurl and attributes\n            for (var property in attributes) {\n                iframeurl = iframeurl + property + '=' + attributes[property] + '&';\n            }\n            iframe.setAttribute('src', iframeurl);\n\n            //do any iframe attributes that we need to\n            //width and height (only if no iframe class specified)\n            //see here for responsive iframe ..https://blog.theodo.fr/2018/01/responsive-iframes-css-trick/\n            if (attributes.hasOwnProperty('iframeclass')) {\n                iframe.setAttribute('class', attributes.iframeclass);\n            } else {\n                if (!attributes.hasOwnProperty('width')) {\n                    attributes['width'] = 350;\n                }\n                iframe.setAttribute('width', attributes.width);\n                if (!attributes.hasOwnProperty('height')) {\n                    if (attributes['media'] == 'audio') {\n                        attributes['height'] = 250;\n                    } else {\n                        attributes['height'] = 550;\n                    }\n                }\n                iframe.setAttribute('height', attributes.height);\n            }\n            iframe.setAttribute('frameBorder', 0);\n            iframe.setAttribute('allow', 'camera; microphone; display-capture');\n            return iframe;\n        },\n        theCallback: function (data) {\n            switch (data.type) {\n                case 'filesubmitted':\n                    var inputControl = data.updatecontrol;\n                    var pokeInput = document.getElementById(inputControl);\n                    var theurl = data.mediaurl;\n                    if (pokeInput) {\n                        pokeInput.value = theurl;\n                    }\n                    break;\n                case 'error':\n                    alert('ERROR:'.data.message);\n            }\n        },\n        initEvents: function () {\n            var that = this;\n            window.addEventListener('message', function (e) {\n                var data = e.data;\n                if (data && data.hasOwnProperty('id') && data.hasOwnProperty('type')) {\n                    that.theCallback(data);\n                }\n            });\n        },\n        sendMessage: function (containerid, messageObject) {\n\n            if (!messageObject.hasOwnProperty('type')) {\n                //'All message objects must have at least the \"type\" property'\n                return;\n            }\n\n            var theiframe = document.getElementById(containerid).getElementsByTagName('iframe')[0];\n\n            //messageObject.id = this.id;\n            theiframe.contentWindow.postMessage(messageObject);\n\n        },\n        fetchroot: function () {\n            return this;\n        },\n\n        is_safari: function () {\n            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n        },\n\n        is_ios: function () {\n            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n        },\n\n        guess_mimetype: function (mediatype, transcribe, hints) {\n\n            //if we are using Google Cloud Speech Transcribe then we only support audio/wav\n            if (transcribe == 2) {\n                return \"audio/wav\";\n            }\n            //this is a bit hacky, we should base64decode hints and look for the value of hints.encoder\n            if (hints && hints.includes('stereoaudio')) {\n                return \"audio/wav\";\n            }\n\n            // var nVer = navigator.appVersion;\n            var nAgt = navigator.userAgent;\n            var browserName = navigator.appName;\n            //decided no real benefit and some danger in detecting version, so commented it mostly\n            var fullVersion = '' + parseFloat(navigator.appVersion);\n            var nameOffset, verOffset;\n\n            if (nAgt.match('(?:Edge|EdgA|EdgiOS)') !== null) {\n                browserName = \"Edge\";\n                //dont know how to get this and its probably not important yet\n                //fullVersion = '1.0';\n\n                // In Opera, the true version is after \"Opera\" or after \"Version\"\n            } else if ((verOffset = nAgt.indexOf(\"Opera\")) != -1) {\n                browserName = \"Opera\";\n                //fullVersion = nAgt.substring(verOffset+6);\n                //if ((verOffset=nAgt.indexOf(\"Version\"))!=-1) fullVersion = nAgt.substring(verOffset+8);\n            }\n            // In MSIE, the true version is after \"MSIE\" in userAgent\n            else if ((verOffset = nAgt.indexOf(\"MSIE\")) != -1) {\n                browserName = \"IE\";\n                //fullVersion = nAgt.substring(verOffset+5);\n            }\n            // In Chrome, the true version is after \"Chrome\"\n            else if ((verOffset = nAgt.indexOf(\"Chrome\")) != -1) {\n                browserName = \"Chrome\";\n                //fullVersion = nAgt.substring(verOffset+7);\n            }\n            // In Safari, the true version is after \"Safari\" or after \"Version\"\n            else if ((verOffset = nAgt.indexOf(\"Safari\")) != -1) {\n                browserName = \"Safari\";\n                //fullVersion = nAgt.substring(verOffset+7);\n                //if ((verOffset=nAgt.indexOf(\"Version\"))!=-1)fullVersion = nAgt.substring(verOffset+8);\n            }\n            // In Firefox, the true version is after \"Firefox\"\n            else if ((verOffset = nAgt.indexOf(\"Firefox\")) != -1) {\n                browserName = \"Firefox\";\n                //fullVersion = nAgt.substring(verOffset + 8);\n                // In most other browsers, \"name/version\" is at the end of userAgent\n            } else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) <\n                (verOffset = nAgt.lastIndexOf('/'))) {\n                browserName = nAgt.substring(nameOffset, verOffset);\n                //fullVersion = nAgt.substring(verOffset+1);\n                if (browserName.toLowerCase() == browserName.toUpperCase()) {\n                    browserName = navigator.appName;\n                }\n            }\n\n\n            //OS detection\n            var OS = \"Unknown OS\";\n            if (navigator.userAgent.indexOf(\"Win\") != -1) { OS = \"Windows\"; }\n            if (navigator.userAgent.indexOf(\"Mac\") != -1) { OS = \"Macintosh\"; }\n            if (navigator.userAgent.indexOf(\"Linux\") != -1) { OS = \"Linux\"; }\n            if (navigator.userAgent.indexOf(\"Android\") != -1) { OS = \"Android\"; }\n            if (navigator.userAgent.indexOf(\"like Mac\") != -1) { OS = \"iOS\"; }\n\n\n            var browser = {};\n            browser.name = browserName;\n            browser.version = fullVersion;\n            browser.OS = OS;\n\n            //predicted mimetype\n            var mimetype = \"unsupported/unsupported\";\n            if (mediatype == 'video') {\n                switch (browser.name) {\n                    case 'Edge':\n                    case 'MSIE':\n                        mimetype = \"video/webm\";\n                        break;\n                    case 'Safari':\n                        mimetype = \"video/quicktime\";\n                        //new mobile safari .. but how to detect?\n                        //mimetype=\"video/mp4\";\n                        break;\n                    case 'Firefox':\n                    case 'Chrome':\n                    case 'Opera':\n                    default:\n                        mimetype = \"video/webm\";\n                }\n            } else {\n                switch (browser.name) {\n                    case 'MSIE':\n                        mimetype = \"audio/wav\";\n                        break;\n                    case 'Safari':\n                        mimetype = \"audio/wav\";\n                        //new mobile safari ... but how do we know?\n                        mimetype = \"audio/mpa\";\n                        break;\n                    case 'Firefox':\n                        mimetype = \"audio/ogg\";\n                        break;\n                    case 'Chrome':\n                    case 'Opera':\n                    case 'Edge':\n                    default:\n                        mimetype = \"audio/webm\";\n                }\n            }\n            /*\n            document.write(''\n                +'Browser name  = '+browser.name+'<br>'\n                +'Full version  = '+browser.version+'<br>'\n                +'OS  = '+browser.OS+'<br>'\n                +'mimetype  = '+mimetype+'<br>'\n            )\n            */\n            return mimetype;\n        }//end of guess mimetype\n    };//end of returned object (poodllcloud)\n});//end of factory method container"],"names":["define","version","baseURL","params","setBaseUrl","cloudpoodllurl","fetchContainers","classname","document","getElementsByClassName","autoCreateRecorders","containers","this","ctr","length","insertRecorder","createRecorder","elementid","theelement","getElementById","container","attributes","undefined","parseAttributes","iframe","createIframe","appendChild","setAttribute","i","attr","getAttribute","hasOwnProperty","window","location","protocol","hostname","guess_mimetype","createElement","localloading","iframeurl","is_ios","is_safari","property","iframeclass","width","height","theCallback","data","type","inputControl","updatecontrol","pokeInput","theurl","mediaurl","value","alert","message","initEvents","that","addEventListener","e","sendMessage","containerid","messageObject","getElementsByTagName","contentWindow","postMessage","fetchroot","test","navigator","userAgent","MSStream","mediatype","transcribe","hints","includes","nameOffset","verOffset","nAgt","browserName","appName","fullVersion","parseFloat","appVersion","match","indexOf","lastIndexOf","substring","toLowerCase","toUpperCase","OS","browser","name","mimetype"],"mappings":"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"}