{"version":3,"file":"drawing_board.min.js","sources":["../src/drawing_board.js"],"sourcesContent":["define(['jquery'], function ($) {\n    \"use strict\";\n\n    var DrawingBoard = function (canvasid) {\n        this.canvas = document.getElementById(canvasid);\n        this.ctx = this.canvas.getContext('2d');\n        this.width = this.canvas.width;\n        this.height = this.canvas.height;\n\n        this.drawing = false;\n        this.steps = [];\n        this.redoStack = [];\n        this.currentStep = null;\n\n        this.tool = 'pencil';\n        this.strokeColor = '#000000';\n        this.fillColor = '#ffffff';\n        this.bgColor = '#ffffff';\n        this.strokeSize = 5;\n\n        this.backimage = null;\n        this.zoom = 1;\n\n        this.init();\n    };\n\n    DrawingBoard.prototype.init = function () {\n        var that = this;\n\n        $(this.canvas).on('mousedown touchstart', function (e) {\n            if (that.tool === 'text' || that.tool === 'stamp') {\n                return; // Let whiteboard.js handle these exclusively\n            }\n            that.drawing = true;\n            var pos = that.getPos(e);\n\n            that.currentStep = {\n                type: that.tool,\n                points: [pos],\n                strokeColor: that.strokeColor,\n                fillColor: that.fillColor,\n                strokeSize: that.strokeSize\n            };\n\n            that.redraw();\n        });\n\n        $(document).on('mousemove touchmove', function (e) {\n            if (!that.drawing) {\n                return;\n            }\n            var pos = that.getPos(e);\n\n            if (that.tool === 'pencil' || that.tool === 'eraser' || that.tool === 'highlighter') {\n                that.currentStep.points.push(pos);\n            } else {\n                // For shapes, we only care about start and end\n                if (that.currentStep.points.length > 1) {\n                    that.currentStep.points[1] = pos;\n                } else {\n                    that.currentStep.points.push(pos);\n                }\n            }\n\n            that.redraw();\n            e.preventDefault();\n        });\n\n        $(document).on('mouseup touchend', function () {\n            if (that.drawing) {\n                that.drawing = false;\n                if (that.currentStep) {\n                    this.addStep(that.currentStep);\n                }\n                that.currentStep = null;\n                that.redraw();\n            }\n        }.bind(this));\n    };\n\n    DrawingBoard.prototype.addStep = function (step) {\n        this.steps.push(step);\n        this.redoStack = []; // Clear redo on new action\n        $(this.canvas).trigger('wb:changed');\n    };\n\n    DrawingBoard.prototype.undo = function () {\n        if (this.steps.length > 0) {\n            this.redoStack.push(this.steps.pop());\n            this.redraw();\n            $(this.canvas).trigger('wb:changed');\n        }\n    };\n\n    DrawingBoard.prototype.redo = function () {\n        if (this.redoStack.length > 0) {\n            this.steps.push(this.redoStack.pop());\n            this.redraw();\n            $(this.canvas).trigger('wb:changed');\n        }\n    };\n\n    DrawingBoard.prototype.getPos = function (e) {\n        var rect = this.canvas.getBoundingClientRect();\n        var clientX = e.clientX || (e.originalEvent && e.originalEvent.touches ? e.originalEvent.touches[0].clientX : 0);\n        var clientY = e.clientY || (e.originalEvent && e.originalEvent.touches ? e.originalEvent.touches[0].clientY : 0);\n        return {\n            x: (clientX - rect.left) / this.zoom,\n            y: (clientY - rect.top) / this.zoom\n        };\n    };\n\n    DrawingBoard.prototype.redraw = function () {\n        this.ctx.clearRect(0, 0, this.width, this.height);\n\n        // Fill background\n        this.ctx.fillStyle = this.bgColor;\n        this.ctx.fillRect(0, 0, this.width, this.height);\n\n        if (this.backimage) {\n            this.ctx.drawImage(this.backimage, 0, 0, this.width, this.height);\n        }\n\n        this.steps.forEach(function (step) {\n            this.drawStep(step);\n        }.bind(this));\n\n        if (this.currentStep) {\n            this.drawStep(this.currentStep);\n        }\n    };\n\n    DrawingBoard.prototype.drawStep = function (step) {\n        this.ctx.lineJoin = 'round';\n        this.ctx.lineCap = 'round';\n        this.ctx.strokeStyle = step.strokeColor;\n        this.ctx.fillStyle = step.fillColor;\n        this.ctx.lineWidth = step.strokeSize;\n\n        if (step.type === 'eraser') {\n            this.ctx.strokeStyle = this.bgColor;\n        }\n\n        switch (step.type) {\n            case 'pencil':\n            case 'eraser':\n            case 'highlighter':\n                this.ctx.beginPath();\n                this.ctx.moveTo(step.points[0].x, step.points[0].y);\n                step.points.forEach(function (p) {\n                    this.ctx.lineTo(p.x, p.y);\n                }.bind(this));\n\n                if (step.type === 'highlighter') {\n                    this.ctx.globalAlpha = 0.5;\n                    this.ctx.stroke();\n                    this.ctx.globalAlpha = 1.0;\n                } else {\n                    this.ctx.stroke();\n                }\n                break;\n            case 'line':\n                if (step.points.length < 2) return;\n                this.ctx.beginPath();\n                this.ctx.moveTo(step.points[0].x, step.points[0].y);\n                this.ctx.lineTo(step.points[1].x, step.points[1].y);\n                this.ctx.stroke();\n                break;\n            case 'rect':\n                if (step.points.length < 2) return;\n                var x = Math.min(step.points[0].x, step.points[1].x);\n                var y = Math.min(step.points[0].y, step.points[1].y);\n                var w = Math.abs(step.points[1].x - step.points[0].x);\n                var h = Math.abs(step.points[1].y - step.points[0].y);\n                this.ctx.fillRect(x, y, w, h);\n                this.ctx.strokeRect(x, y, w, h);\n                break;\n            case 'circle':\n                if (step.points.length < 2) return;\n                var dx = step.points[1].x - step.points[0].x;\n                var dy = step.points[1].y - step.points[0].y;\n                var radius = Math.sqrt(dx * dx + dy * dy);\n                this.ctx.beginPath();\n                this.ctx.arc(step.points[0].x, step.points[0].y, radius, 0, 2 * Math.PI);\n                this.ctx.fill();\n                this.ctx.stroke();\n                break;\n            case 'stamp':\n                if (step.stamp && step.paths && step.paths[step.stamp]) {\n                    this.ctx.save();\n                    if (step.strokeColor !== 'transparent') {\n                        this.ctx.fillStyle = step.strokeColor;\n                    }\n                    var p = new Path2D(step.paths[step.stamp]);\n\n                    var x = step.points[0].x;\n                    var y = step.points[0].y;\n\n                    var cx = x + step.width / 2;\n                    var cy = y + step.height / 2;\n\n                    this.ctx.translate(cx, cy);\n                    var scaleX = step.width / 512;\n                    var scaleY = step.height / 512;\n                    this.ctx.scale(scaleX, scaleY);\n\n                    // Move back to draw path at origin (-256, -256) since viewBox is 512x512\n                    this.ctx.translate(-256, -256);\n\n                    if (step.strokeColor !== 'transparent') {\n                        this.ctx.fill(p);\n                    }\n                    this.ctx.restore();\n                }\n                break;\n            case 'text':\n                if (step.text) {\n                    var fontStyle = step.isItalic ? \"italic \" : \"\";\n                    var fontWeight = step.isBold ? \"bold \" : \"\";\n                    var fontSize = step.fontSize || (step.strokeSize * 5); // Fallback to old behavior\n                    var fontFamily = step.fontFamily || \"Arial\";\n\n                    this.ctx.font = fontStyle + fontWeight + fontSize + \"px \" + fontFamily;\n                    this.ctx.textBaseline = \"top\"; // Better alignment for multiline\n                    this.ctx.fillStyle = step.strokeColor; // Use stroke color instead of fill color for text\n\n                    var maxWidth = step.width || 9999;\n                    var paragraphs = step.text.split('\\n');\n                    var lineHeight = fontSize * 1.2; // Approximate line height\n                    var startX = step.points[0].x + 4; // Add a small padding to match textarea\n                    var startY = step.points[0].y + 4;\n\n                    var y = startY;\n                    for (var i = 0; i < paragraphs.length; i++) {\n                        var words = paragraphs[i].split(' ');\n                        var line = '';\n                        for (var n = 0; n < words.length; n++) {\n                            var testLine = line + words[n] + ' ';\n                            var metrics = this.ctx.measureText(testLine);\n                            var testWidth = metrics.width;\n                            if (testWidth > maxWidth && n > 0) {\n                                this.ctx.fillText(line, startX, y);\n                                line = words[n] + ' ';\n                                y += lineHeight;\n                            } else {\n                                line = testLine;\n                            }\n                        }\n                        this.ctx.fillText(line, startX, y);\n                        y += lineHeight;\n                    }\n                }\n                break;\n        }\n    };\n\n    DrawingBoard.prototype.clear = function () {\n        this.addStep({\n            type: 'clear',\n            bgColor: this.bgColor\n        });\n        this.steps = [];\n        this.redraw();\n    };\n\n    DrawingBoard.prototype.setBackImage = function (url) {\n        var img = new Image();\n        img.onload = function () {\n            this.backimage = img;\n\n            // Adjust canvas height to match aspect ratio (keeping width fixed)\n            var aspect = img.width / img.height;\n            var newHeight = this.width / aspect;\n\n            this.height = newHeight;\n            this.canvas.height = newHeight;\n\n            this.redraw();\n\n            // Notify whiteboard.js to update container size\n            $(this.canvas).trigger('wb:resized', [{ width: this.width, height: this.height }]);\n        }.bind(this);\n        img.src = url;\n    };\n\n    DrawingBoard.prototype.setVectorData = function (steps) {\n        this.steps = steps;\n        this.redraw();\n    };\n\n    DrawingBoard.prototype.getVectorData = function () {\n        return JSON.stringify(this.steps);\n    };\n\n    DrawingBoard.prototype.getImageData = function () {\n        return this.canvas.toDataURL('image/jpeg', 0.8);\n    };\n\n    DrawingBoard.prototype.loadVectorData = function (json) {\n        try {\n            this.steps = JSON.parse(json);\n            this.redraw();\n        } catch (e) {\n            console.error(\"Error loading vector data\", e);\n        }\n    };\n\n    return DrawingBoard;\n});\n"],"names":["define","$","DrawingBoard","canvasid","canvas","document","getElementById","ctx","this","getContext","width","height","drawing","steps","redoStack","currentStep","tool","strokeColor","fillColor","bgColor","strokeSize","backimage","zoom","init","prototype","that","on","e","pos","getPos","type","points","redraw","push","length","preventDefault","addStep","bind","step","trigger","undo","pop","redo","rect","getBoundingClientRect","clientX","originalEvent","touches","clientY","x","left","y","top","clearRect","fillStyle","fillRect","drawImage","forEach","drawStep","lineJoin","lineCap","strokeStyle","lineWidth","beginPath","moveTo","p","lineTo","globalAlpha","stroke","Math","min","w","abs","h","strokeRect","dx","dy","radius","sqrt","arc","PI","fill","stamp","paths","save","Path2D","cx","cy","translate","scaleX","scaleY","scale","restore","text","fontStyle","isItalic","fontWeight","isBold","fontSize","fontFamily","font","textBaseline","maxWidth","paragraphs","split","lineHeight","startX","i","words","line","n","testLine","measureText","fillText","clear","setBackImage","url","img","Image","onload","aspect","newHeight","src","setVectorData","getVectorData","JSON","stringify","getImageData","toDataURL","loadVectorData","json","parse","console","error"],"mappings":"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"}