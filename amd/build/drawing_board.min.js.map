{"version":3,"file":"drawing_board.min.js","sources":["../src/drawing_board.js"],"sourcesContent":["define(['jquery'], function ($) {\n    \"use strict\";\n\n    var DrawingBoard = function (canvasid) {\n        this.canvas = document.getElementById(canvasid);\n        this.ctx = this.canvas.getContext('2d');\n        this.width = this.canvas.width;\n        this.height = this.canvas.height;\n\n        this.drawing = false;\n        this.steps = [];\n        this.redoStack = [];\n        this.currentStep = null;\n\n        this.tool = 'pencil';\n        this.strokeColor = '#000000';\n        this.fillColor = '#ffffff';\n        this.bgColor = '#ffffff';\n        this.strokeSize = 5;\n\n        this.backimage = null;\n        this.zoom = 1;\n\n        this.init();\n    };\n\n    DrawingBoard.prototype.init = function () {\n        var that = this;\n\n        $(this.canvas).on('mousedown touchstart', function (e) {\n            if (that.tool === 'text') {\n                return; // Let whiteboard.js handle text exclusively\n            }\n            that.drawing = true;\n            var pos = that.getPos(e);\n\n            that.currentStep = {\n                type: that.tool,\n                points: [pos],\n                strokeColor: that.strokeColor,\n                fillColor: that.fillColor,\n                strokeSize: that.strokeSize\n            };\n\n            if (that.tool === 'picker') {\n                that.pickColor(pos);\n                that.drawing = false;\n                return;\n            }\n\n            that.redraw();\n        });\n\n        $(document).on('mousemove touchmove', function (e) {\n            if (!that.drawing) {\n                return;\n            }\n            var pos = that.getPos(e);\n\n            if (that.tool === 'pencil' || that.tool === 'eraser') {\n                that.currentStep.points.push(pos);\n            } else {\n                // For shapes, we only care about start and end\n                if (that.currentStep.points.length > 1) {\n                    that.currentStep.points[1] = pos;\n                } else {\n                    that.currentStep.points.push(pos);\n                }\n            }\n\n            that.redraw();\n            e.preventDefault();\n        });\n\n        $(document).on('mouseup touchend', function () {\n            if (that.drawing) {\n                that.drawing = false;\n                if (that.currentStep) {\n                    this.addStep(that.currentStep);\n                }\n                that.currentStep = null;\n                that.redraw();\n            }\n        }.bind(this));\n    };\n\n    DrawingBoard.prototype.addStep = function (step) {\n        this.steps.push(step);\n        this.redoStack = []; // Clear redo on new action\n        $(this.canvas).trigger('wb:changed');\n    };\n\n    DrawingBoard.prototype.undo = function () {\n        if (this.steps.length > 0) {\n            this.redoStack.push(this.steps.pop());\n            this.redraw();\n            $(this.canvas).trigger('wb:changed');\n        }\n    };\n\n    DrawingBoard.prototype.redo = function () {\n        if (this.redoStack.length > 0) {\n            this.steps.push(this.redoStack.pop());\n            this.redraw();\n            $(this.canvas).trigger('wb:changed');\n        }\n    };\n\n    DrawingBoard.prototype.getPos = function (e) {\n        var rect = this.canvas.getBoundingClientRect();\n        var clientX = e.clientX || (e.originalEvent && e.originalEvent.touches ? e.originalEvent.touches[0].clientX : 0);\n        var clientY = e.clientY || (e.originalEvent && e.originalEvent.touches ? e.originalEvent.touches[0].clientY : 0);\n        return {\n            x: (clientX - rect.left) / this.zoom,\n            y: (clientY - rect.top) / this.zoom\n        };\n    };\n\n    DrawingBoard.prototype.redraw = function () {\n        this.ctx.clearRect(0, 0, this.width, this.height);\n\n        // Fill background\n        this.ctx.fillStyle = this.bgColor;\n        this.ctx.fillRect(0, 0, this.width, this.height);\n\n        if (this.backimage) {\n            this.ctx.drawImage(this.backimage, 0, 0, this.width, this.height);\n        }\n\n        this.steps.forEach(function (step) {\n            this.drawStep(step);\n        }.bind(this));\n\n        if (this.currentStep) {\n            this.drawStep(this.currentStep);\n        }\n    };\n\n    DrawingBoard.prototype.drawStep = function (step) {\n        this.ctx.lineJoin = 'round';\n        this.ctx.lineCap = 'round';\n        this.ctx.strokeStyle = step.strokeColor;\n        this.ctx.fillStyle = step.fillColor;\n        this.ctx.lineWidth = step.strokeSize;\n\n        if (step.type === 'eraser') {\n            this.ctx.strokeStyle = this.bgColor;\n        }\n\n        switch (step.type) {\n            case 'pencil':\n            case 'eraser':\n                this.ctx.beginPath();\n                this.ctx.moveTo(step.points[0].x, step.points[0].y);\n                step.points.forEach(function (p) {\n                    this.ctx.lineTo(p.x, p.y);\n                }.bind(this));\n                this.ctx.stroke();\n                break;\n            case 'line':\n                if (step.points.length < 2) return;\n                this.ctx.beginPath();\n                this.ctx.moveTo(step.points[0].x, step.points[0].y);\n                this.ctx.lineTo(step.points[1].x, step.points[1].y);\n                this.ctx.stroke();\n                break;\n            case 'rect':\n                if (step.points.length < 2) return;\n                var x = Math.min(step.points[0].x, step.points[1].x);\n                var y = Math.min(step.points[0].y, step.points[1].y);\n                var w = Math.abs(step.points[1].x - step.points[0].x);\n                var h = Math.abs(step.points[1].y - step.points[0].y);\n                this.ctx.fillRect(x, y, w, h);\n                this.ctx.strokeRect(x, y, w, h);\n                break;\n            case 'circle':\n                if (step.points.length < 2) return;\n                var dx = step.points[1].x - step.points[0].x;\n                var dy = step.points[1].y - step.points[0].y;\n                var radius = Math.sqrt(dx * dx + dy * dy);\n                this.ctx.beginPath();\n                this.ctx.arc(step.points[0].x, step.points[0].y, radius, 0, 2 * Math.PI);\n                this.ctx.fill();\n                this.ctx.stroke();\n                break;\n            case 'text':\n                if (step.text) {\n                    var fontStyle = step.isItalic ? \"italic \" : \"\";\n                    var fontWeight = step.isBold ? \"bold \" : \"\";\n                    var fontSize = step.fontSize || (step.strokeSize * 5); // Fallback to old behavior\n                    var fontFamily = step.fontFamily || \"Arial\";\n\n                    this.ctx.font = fontStyle + fontWeight + fontSize + \"px \" + fontFamily;\n                    this.ctx.textBaseline = \"top\"; // Better alignment for multiline\n                    this.ctx.fillStyle = step.strokeColor; // Use stroke color instead of fill color for text\n\n                    var maxWidth = step.width || 9999;\n                    var paragraphs = step.text.split('\\n');\n                    var lineHeight = fontSize * 1.2; // Approximate line height\n                    var startX = step.points[0].x + 4; // Add a small padding to match textarea\n                    var startY = step.points[0].y + 4;\n\n                    var y = startY;\n                    for (var i = 0; i < paragraphs.length; i++) {\n                        var words = paragraphs[i].split(' ');\n                        var line = '';\n                        for (var n = 0; n < words.length; n++) {\n                            var testLine = line + words[n] + ' ';\n                            var metrics = this.ctx.measureText(testLine);\n                            var testWidth = metrics.width;\n                            if (testWidth > maxWidth && n > 0) {\n                                this.ctx.fillText(line, startX, y);\n                                line = words[n] + ' ';\n                                y += lineHeight;\n                            } else {\n                                line = testLine;\n                            }\n                        }\n                        this.ctx.fillText(line, startX, y);\n                        y += lineHeight;\n                    }\n                }\n                break;\n        }\n    };\n\n    DrawingBoard.prototype.pickColor = function (pos) {\n        var imgData = this.ctx.getImageData(pos.x, pos.y, 1, 1).data;\n        var hex = \"#\" + (\"000000\" + this.rgbToHex(imgData[0], imgData[1], imgData[2])).slice(-6);\n        $(this.canvas).trigger('wb:colorpicked', [hex]);\n    };\n\n    DrawingBoard.prototype.rgbToHex = function (r, g, b) {\n        if (r > 255 || g > 255 || b > 255) throw \"Invalid color component\";\n        return ((r << 16) | (g << 8) | b).toString(16);\n    };\n\n    DrawingBoard.prototype.clear = function () {\n        this.addStep({\n            type: 'clear',\n            bgColor: this.bgColor\n        });\n        this.steps = [];\n        this.redraw();\n    };\n\n    DrawingBoard.prototype.setBackImage = function (url) {\n        var img = new Image();\n        img.onload = function () {\n            this.backimage = img;\n\n            // Adjust canvas height to match aspect ratio (keeping width fixed)\n            var aspect = img.width / img.height;\n            var newHeight = this.width / aspect;\n\n            this.height = newHeight;\n            this.canvas.height = newHeight;\n\n            this.redraw();\n\n            // Notify whiteboard.js to update container size\n            $(this.canvas).trigger('wb:resized', [{ width: this.width, height: this.height }]);\n        }.bind(this);\n        img.src = url;\n    };\n\n    DrawingBoard.prototype.setVectorData = function (steps) {\n        this.steps = steps;\n        this.redraw();\n    };\n\n    DrawingBoard.prototype.getVectorData = function () {\n        return JSON.stringify(this.steps);\n    };\n\n    DrawingBoard.prototype.getImageData = function () {\n        return this.canvas.toDataURL('image/jpeg', 0.8);\n    };\n\n    DrawingBoard.prototype.loadVectorData = function (json) {\n        try {\n            this.steps = JSON.parse(json);\n            this.redraw();\n        } catch (e) {\n            console.error(\"Error loading vector data\", e);\n        }\n    };\n\n    return DrawingBoard;\n});\n"],"names":["define","$","DrawingBoard","canvasid","canvas","document","getElementById","ctx","this","getContext","width","height","drawing","steps","redoStack","currentStep","tool","strokeColor","fillColor","bgColor","strokeSize","backimage","zoom","init","prototype","that","on","e","pos","getPos","type","points","pickColor","redraw","push","length","preventDefault","addStep","bind","step","trigger","undo","pop","redo","rect","getBoundingClientRect","clientX","originalEvent","touches","clientY","x","left","y","top","clearRect","fillStyle","fillRect","drawImage","forEach","drawStep","lineJoin","lineCap","strokeStyle","lineWidth","beginPath","moveTo","p","lineTo","stroke","Math","min","w","abs","h","strokeRect","dx","dy","radius","sqrt","arc","PI","fill","text","fontStyle","isItalic","fontWeight","isBold","fontSize","fontFamily","font","textBaseline","maxWidth","paragraphs","split","lineHeight","startX","i","words","line","n","testLine","measureText","fillText","imgData","getImageData","data","hex","rgbToHex","slice","r","g","b","toString","clear","setBackImage","url","img","Image","onload","aspect","newHeight","src","setVectorData","getVectorData","JSON","stringify","toDataURL","loadVectorData","json","parse","console","error"],"mappings":"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"}