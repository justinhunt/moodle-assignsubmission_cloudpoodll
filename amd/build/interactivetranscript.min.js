define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Interactive Transcript: initialising"),{init:function(b){var c=b.component,d=b.playerid,e=b.containerid,f=b.cssprefix;if(d&&a("#"+d).length){this.config.component=c,this.config.prefix=f,this.config.player=a("#"+d)[0],this.config.title=M.util.get_string("transcripttitle",c),this.doPolyfills();var g=this.transcript();a("#"+e).append(g.el())}},doPolyfills:function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)}),"function"!=typeof Object.create&&(Object.create=function(){var a=function(){};return function(b){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof b)throw TypeError("Argument must be an object");a.prototype=b;var c=new a;return a.prototype=null,c}}()),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null==this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;d<f;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),"document"in self&&!("classList"in document.createElement("_"))&&!function(a){if("Element"in a){var b="classList",c="prototype",d=a.Element[c],e=Object,f=String[c].trim||function(){return this.replace(/^\s+|\s+$/g,"")},g=Array[c].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},h=function(a,b){this.name=a,this.code=DOMException[a],this.message=b},i=function(a,b){if(""===b)throw new h("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(b))throw new h("INVALID_CHARACTER_ERR","String contains an invalid character");return g.call(a,b)},j=function(a){for(var b=f.call(a.getAttribute("class")||""),c=b?b.split(/\s+/):[],d=0,e=c.length;d<e;d++)this.push(c[d]);this._updateClassName=function(){a.setAttribute("class",this.toString())}},k=j[c]=[],l=function(){return new j(this)};if(h[c]=Error[c],k.item=function(a){return this[a]||null},k.contains=function(a){return a+="",i(this,a)!==-1},k.add=function(){var a,b=arguments,c=0,d=b.length,e=!1;do a=b[c]+"",i(this,a)===-1&&(this.push(a),e=!0);while(++c<d);e&&this._updateClassName()},k.remove=function(){var a,b=arguments,c=0,d=b.length,e=!1;do{a=b[c]+"";var f=i(this,a);f!==-1&&(this.splice(f,1),e=!0)}while(++c<d);e&&this._updateClassName()},k.toggle=function(a,b){a+="";var c=this.contains(a),d=c?b!==!0&&"remove":b!==!1&&"add";return d&&this[d](a),!c},k.toString=function(){return this.join(" ")},e.defineProperty){var m={get:l,enumerable:!0,configurable:!0};try{e.defineProperty(d,b,m)}catch(n){n.number===-2146823252&&(m.enumerable=!1,e.defineProperty(d,b,m))}}else e[c].__defineGetter__&&d.__defineGetter__(b,l)}}(self)},config:{settings:{},prefix:"transcript",player:!1},defaults:{autoscroll:!0,clickArea:"line",showTitle:!0,showTrackSelector:!1,followPlayerTrack:!0,scrollToCenter:!1,stopScrollWhenInUse:!0},utils:{prefix:"transcript",secondsToTime:function(a){var b=Math.floor(a/3600),c=Math.floor(a%3600/60),d=Math.floor(a%60);return d=d<10?"0"+d:d,c=b>0&&c<10?"0"+c:c,b>0?b+":"+c+":"+d:c+":"+d},localize:function(a){return a},createEl:function(a,b){b=b||"";var c=document.createElement(a);return c.className=b,c},extend:function(a){var b=typeof a;if(!("function"===b||"object"===b&&a))return a;for(var c,d,e=1,f=arguments.length;e<f;e++){c=arguments[e];for(d in c)a[d]=c[d]}return a}},eventEmitter:{handlers_:[],on:function(a,b,c){if("function"!=typeof c)throw new TypeError("Callback is not a function.");this.handlers_.push([a,b,c])},trigger:function(a,b){this.handlers_.forEach(function(c){c[0]===a&&c[1]===b&&c[2].apply()})}},scrollerProto:function(){var a=function(a){var b=this;a.addEventListener("scroll",function(){b.isAutoScrolling?b.isAutoScrolling=!1:(b.userIsScrolling=!0,a.classList.add("is-inuse"))}),a.addEventListener("mouseenter",function(){b.mouseIsOverTranscript=!0}),a.addEventListener("mouseleave",function(){b.mouseIsOverTranscript=!1,setTimeout(function(){b.mouseIsOverTranscript||(b.userIsScrolling=!1,a.classList.remove("is-inuse"))},1e3)})},b=function(b){return this.element=b,this.userIsScrolling=!1,this.mouseIsOverTranscript=!0,this.isAutoScrolling=!0,a.call(this,this.element),this},c=function(a,b,c,d){return b+c*Math.sin(Math.min(1,a/d)*(Math.PI/2))},d=function(a,b,d){var e=Date.now(),f=a.scrollTop,g=this;b=Math.max(0,b),b=Math.min(a.scrollHeight-a.clientHeight,b);var h=b-f,i=function(){var j=Date.now(),k=j-e;g.isAutoScrolling=!0,a.scrollTop=c(k,f,h,d),a.scrollTop!==b&&requestAnimationFrame(i,a)};requestAnimationFrame(i,a)},e=function(a){if(this.canScroll()){var b,c=a.parentElement,e=(c.offsetTop+c.clientHeight,a.offsetTop+a.clientHeight),f=a.offsetTop,g=a.offsetTop+a.clientHeight,h=0;console.log("element.offsetTop: "+a.offsetTop),console.log("element.clientHeight: "+a.clientHeight),console.log("parent.offsetTop: "+c.offsetTop),console.log("parent.scrollTop: "+c.scrollTop),console.log("parent.clientHeight: "+c.clientHeight),console.log(a),console.log(c),f<c.scrollTop+h?b=a.offsetTop-h:g>c.scrollTop+c.clientHeight-h&&(b=e+h),void 0!==b&&c.scrollTop!==b&&d.call(this,c,b,400)}},f=function(){var a=this.element;return a.scrollHeight>a.offsetHeight},g=function(){return this.userIsScrolling};return{init:b,to:e,canScroll:f,inUse:g}},scroller:function(a){return Object.create(this.scrollerProto()).init(a)},trackList:function(){var a,b=this.config;return{get:function(){var a,c,d=[];for(b.tracks=b.player.textTracks,a=0;a<b.tracks.length;a++)c=b.tracks[a],"captions"!==c.kind&&"subtitles"!==c.kind||d.push(c);return d},active:function(c){var d,e;for(d=0;d<b.tracks.length;d++)if(e=b.tracks[d],"showing"===e.mode)return a=e,e;return a||c[0]}}},widget:function(){var a=this,b=this.config,c={};c.element={},c.body={};var d=function(b,c){eventEmitter.on(a,b,c)},e=function(b){eventEmitter.trigger(a,b)},f=function(){var c=a.utils.createEl("header",b.prefix+"-header");return c.textContent=a.config.title,c},g=function(){var c=a.utils.createEl("select",b.prefix+"-selector");return b.validTracks.forEach(function(a,b){var d=document.createElement("option");d.value=b,d.textContent=a.label+" ("+a.language+")",c.appendChild(d)}),c.addEventListener("change",function(a){l(document.querySelector("#"+b.prefix+"-"+b.player.id+" option:checked").value),e("trackchanged")}),c},h=function(a){var c=a.target.classList,d=a.target.getAttribute("data-begin")||a.target.parentElement.getAttribute("data-begin");void 0!==d&&null!==d&&("line"===b.settings.clickArea||"timestamp"===b.settings.clickArea&&c.contains(b.prefix+"-timestamp")||"text"===b.settings.clickArea&&c.contains(b.prefix+"-text"))&&(b.player.currentTime=d)},i=function(d){var e=a.utils.createEl("div",b.prefix+"-line"),f=a.utils.createEl("span",b.prefix+"-timestamp"),g=a.utils.createEl("span",b.prefix+"-text");return e.setAttribute("data-begin",d.startTime),e.setAttribute("tabindex",c._options.tabIndex||0),f.textContent=a.utils.secondsToTime(d.startTime),g.innerHTML=d.text,e.appendChild(f),e.appendChild(g),e},j=function(d){"object"!=typeof d&&(d=b.player.textTracks()[d]);var e,f,g=a.utils.createEl("div",b.prefix+"-body"),k=document.createDocumentFragment();if(d.activeCues){var l=d.cues;for(f=0;f<l.length;f++)e=i(l[f]),k.appendChild(e);g.innerHTML="",g.appendChild(k),g.setAttribute("lang",d.language),g.scroll=a.scroller(g),g.addEventListener("click",h),c.element.replaceChild(g,c.body),c.body=g}else"showing"!==d.mode&&(d.mode="hidden"),window.setTimeout(function(){j(d)},100)},k=function(d){var e=document.createElement("div");if(c._options=d,c.element=e,e.setAttribute("id",b.prefix+"-"+b.player.id),b.settings.showTitle){var h=f();e.appendChild(h)}if(b.settings.showTrackSelector){var i=g();e.appendChild(i)}return c.body=a.utils.createEl("div",b.prefix+"-body"),e.appendChild(c.body),l(b.currentTrack),this},l=function(a,b){j(a,b)},m=function(a){var d,e,f,g,h=c.body.children;for(d=0;d<h.length;d++)e=h[d],f=e.getAttribute("data-begin"),g=d<h.length-1?h[d+1].getAttribute("data-begin"):b.player.duration||1/0,a>f&&a<g?e.classList.contains("is-active")||(e.classList.add("is-active"),!b.settings.autoscroll||b.settings.stopScrollWhenInUse&&c.body.scroll.inUse()||c.body.scroll.to(e)):e.classList.remove("is-active")},n=function(){return c.element};return{create:k,setTrack:l,setCue:m,el:n,on:d,trigger:e}},transcript:function(){var a=this,b=this.defaults,c=this.config;this.utils.prefix="transcript",c.validTracks=this.trackList().get(),c.currentTrack=this.trackList().active(c.validTracks),c.settings=b,c.widget=this.widget().create(b);var d=function(){c.widget.setCue(c.player.currentTime)},e=function(){c.currentTrack=a.trackList().active(c.validTracks),c.widget.setTrack(c.currentTrack)};if(!(c.validTracks.length>0))throw new Error("transcript: No tracks found!");return e(),c.player.ontimeupdate=d,c.settings.followPlayerTrack&&(c.player.oncaptionstrackchange=e,c.player.onsubtitlestrackchange=e),{el:function(){return c.widget.el()},setTrack:c.widget.setTrack}}}});