define("assignsubmission_cloudpoodll/whiteboard",["jquery","core/log","core/ajax","core/notification","core/str","assignsubmission_cloudpoodll/drawing_board"],(function($,log,Ajax,Notification,Str,DrawingBoard){return{strings:{},init:function(uniqueid){var container=$("#"+uniqueid),board=new DrawingBoard(uniqueid+"_canvas");this.setup_strings(container),this.setup_controls(container,board)},setup_strings:function(){var self=this;Str.get_strings([{key:"save",component:"assignsubmission_cloudpoodll"},{key:"saving",component:"assignsubmission_cloudpoodll"},{key:"saved",component:"assignsubmission_cloudpoodll"},{key:"confirmclearcanvas",component:"assignsubmission_cloudpoodll"},{key:"enterthetext",component:"assignsubmission_cloudpoodll"}]).done((function(s){var i=0;self.strings.save=s[i++],self.strings.saving=s[i++],self.strings.saved=s[i++],self.strings.confirmclearcanvas=s[i++],self.strings.enterthetext=s[i++]}))},setup_controls:function(container,board){var self=this,backimage=container.data("backimage");backimage&&board.setBackImage(backimage);var vdata=container.data("vdata");vdata&&board.setVectorData(vdata),container.find(".wb-tool").click((function(){var tool=$(this).data("tool");board.tool=tool,container.find(".wb-tool").removeClass("active"),$(this).addClass("active"),"text"===tool?(container.find(".wb-stroke-sizes").hide(),container.find(".wb-text-settings").show()):(container.find(".wb-text-settings").hide(),container.find(".wb-stroke-sizes").show())})),container.find(".wb-size").click((function(){var size=$(this).data("size");board.strokeSize=size,container.find(".wb-size").removeClass("active"),$(this).addClass("active")})),container.find(".wb-color-box").click((function(){$(this).next(".wb-color-picker").click()})),container.find(".wb-stroke-picker").on("input change",(function(){var color=$(this).val();board.strokeColor=color,container.find(".wb-stroke-color").css("background-color",color)})),container.find(".wb-fill-picker").on("input change",(function(){var color=$(this).val();board.fillColor=color,container.find(".wb-fill-color").css("background-color",color)})),container.find(".wb-bg-picker").on("input change",(function(){var color=$(this).val();board.bgColor=color,container.find(".wb-bg-color").css("background-color",color),board.redraw()})),container.find(".wb-sidebar-toggle").click((function(){container.find(".wb-sidebar").toggleClass("collapsed")})),container.find(".undo-whiteboard").click((function(){board.undo()})),container.find(".redo-whiteboard").click((function(){board.redo()})),container.find(".clear-whiteboard").click((function(){confirm(self.strings.confirmclearcanvas)&&board.clear()}));var baseWidth=container.data("width")||800,baseHeight=container.data("height")||600;$(board.canvas).on("wb:resized",(function(e,dims){baseWidth=dims.width,baseHeight=dims.height,updateZoom()}));var updateZoom=function(){$(board.canvas).css({transform:"scale("+board.zoom+")","transform-origin":"0 0"}),container.find(".assignsubmission_cloudpoodll_whiteboard").css({width:baseWidth*board.zoom+"px",height:baseHeight*board.zoom+"px"})};container.find(".zoom-in").click((function(){board.zoom+=.1,updateZoom()})),container.find(".zoom-out").click((function(){board.zoom>.5&&(board.zoom-=.1,updateZoom())}));var $activeTextBox=null,commitText=function(){if($activeTextBox){var text=$activeTextBox.find("textarea").val();if(""!==text.trim()){var pos=$activeTextBox.position(),step={type:"text",text:text,points:[{x:pos.left/board.zoom,y:pos.top/board.zoom}],width:Math.max(10,($activeTextBox.width()-8)/board.zoom),strokeColor:board.strokeColor,fillColor:board.fillColor,strokeSize:board.strokeSize,fontFamily:container.find(".wb-text-font").val(),fontSize:parseInt(container.find(".wb-text-size").val()),isBold:container.find(".wb-text-bold").is(":checked"),isItalic:container.find(".wb-text-italic").is(":checked")};board.addStep(step),board.redraw()}$activeTextBox.remove(),$activeTextBox=null}};$(board.canvas).on("mousedown touchstart",(function(e){if("text"===board.tool){if($activeTextBox&&$activeTextBox.hasClass("selected"))commitText();else if(!$activeTextBox){var rect=board.canvas.getBoundingClientRect(),touch=e.originalEvent.touches?e.originalEvent.touches[0]:e,clientX=touch.clientX,clientY=touch.clientY;if(clientX>=rect.left&&clientX<=rect.right&&clientY>=rect.top&&clientY<=rect.bottom)!function(x,y){commitText();var $overlay=$('<div class="wb-text-overlay editing"></div>'),$textarea=$('<textarea spellcheck="false"></textarea>'),updateStyles=function(){var fontFamily=container.find(".wb-text-font").val(),fontSize=container.find(".wb-text-size").val()+"px",isBold=container.find(".wb-text-bold").is(":checked"),isItalic=container.find(".wb-text-italic").is(":checked");$textarea.css({"font-family":fontFamily,"font-size":fontSize,"font-weight":isBold?"bold":"normal","font-style":isItalic?"italic":"normal",color:board.strokeColor})};updateStyles(),container.find(".wb-text-settings input, .wb-text-settings select, .wb-stroke-picker").off("change.wblive").on("change.wblive",updateStyles),$overlay.append($textarea),$overlay.css({left:x*board.zoom,top:y*board.zoom});var dragStartX,dragStartY,initialLeft,initialTop,isDragging=!1;$overlay.on("mousedown touchstart",(function(e){if($overlay.hasClass("selected")){isDragging=!0;var touch=e.originalEvent.touches?e.originalEvent.touches[0]:e;dragStartX=touch.pageX,dragStartY=touch.pageY;var pos=$overlay.position();initialLeft=pos.left,initialTop=pos.top,e.stopPropagation()}})),$(document).on("mousemove.wbtextdrag touchmove.wbtextdrag",(function(e){if(isDragging){var touch=e.originalEvent.touches?e.originalEvent.touches[0]:e,dx=touch.pageX-dragStartX,dy=touch.pageY-dragStartY,newLeft=initialLeft+dx,newTop=initialTop+dy,maxLeft=board.canvas.width*board.zoom-$overlay.outerWidth(),maxTop=board.canvas.height*board.zoom-$overlay.outerHeight();newLeft=Math.max(0,Math.min(newLeft,maxLeft)),newTop=Math.max(0,Math.min(newTop,maxTop)),$overlay.css({left:newLeft,top:newTop})}})),$(document).on("mouseup.wbtextdrag touchend.wbtextdrag",(function(e){isDragging=!1})),$textarea.on("blur",(function(){$overlay.removeClass("editing").addClass("selected")})),$overlay.on("click",(function(e){$overlay.hasClass("selected")&&($overlay.removeClass("selected").addClass("editing"),$textarea.focus(),e.stopPropagation())})),container.find(".assignsubmission_cloudpoodll_whiteboard").append($overlay),$textarea.focus(),$activeTextBox=$overlay}((clientX-rect.left)/board.zoom,(clientY-rect.top)/board.zoom)}}else commitText()})),container.find(".wb-tool").click((function(){commitText()})),$(board.canvas).on("wb:colorpicked",(function(e,hex){board.strokeColor=hex,container.find(".wb-stroke-color").css("background-color",hex),container.find(".wb-stroke-picker").val(hex),container.find('[data-tool="pencil"]').click()}));var saveTimer=null,performSave=function(){var btn=container.find(".save-whiteboard");if(!btn.prop("disabled")){var vectorData=board.getVectorData(),imageData=board.getImageData(),vectorControl=$("#"+container.data("vectorcontrol")),updateControl=$("#"+container.data("updatecontrol")),draftitemid=container.data("draftitemid");btn.text(self.strings.saving).prop("disabled",!0),Ajax.call([{methodname:"assignsubmission_cloudpoodll_upload_whiteboard_image",args:{base64data:imageData,draftitemid:draftitemid,filename:"img"+draftitemid+".jpg"}}])[0].then((function(filename){return vectorControl.val(vectorData),updateControl.val(filename),btn.text(self.strings.saved),updateControl.trigger("change"),filename})).catch((function(e){btn.text(self.strings.save).prop("disabled",!1),Notification.exception(e)}))}};container.find(".save-whiteboard").click((function(){saveTimer&&clearTimeout(saveTimer),performSave()})),$(board.canvas).on("wb:changed",(function(){container.find(".save-whiteboard").text(self.strings.save).prop("disabled",!1),saveTimer&&clearTimeout(saveTimer),saveTimer=setTimeout((function(){performSave()}),1e3)}));var vectorControlId=container.data("vectorcontrol");if(vectorControlId){var existingJson=$("#"+vectorControlId).val();existingJson&&board.loadVectorData(existingJson)}}}}));

//# sourceMappingURL=whiteboard.min.js.map