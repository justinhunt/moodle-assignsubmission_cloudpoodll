define("assignsubmission_cloudpoodll/whiteboard",["jquery","core/log","core/ajax","core/notification","core/str","assignsubmission_cloudpoodll/drawing_board"],(function($,log,Ajax,Notification,Str,DrawingBoard){return{strings:{},init:function(uniqueid){var container=$("#"+uniqueid),board=new DrawingBoard(uniqueid+"_canvas");this.setup_strings(container),this.setup_controls(container,board)},setup_strings:function(){var self=this;Str.get_strings([{key:"save",component:"assignsubmission_cloudpoodll"},{key:"saving",component:"assignsubmission_cloudpoodll"},{key:"saved",component:"assignsubmission_cloudpoodll"},{key:"confirmclearcanvas",component:"assignsubmission_cloudpoodll"},{key:"enterthetext",component:"assignsubmission_cloudpoodll"}]).done((function(s){var i=0;self.strings.save=s[i++],self.strings.saving=s[i++],self.strings.saved=s[i++],self.strings.confirmclearcanvas=s[i++],self.strings.enterthetext=s[i++]}))},setup_controls:function(container,board){var self=this,backimage=container.data("backimage");backimage&&board.setBackImage(backimage);var vdata=container.data("vdata");vdata&&board.setVectorData(vdata),container.find(".wb-tool").click((function(){var tool=$(this).data("tool");board.tool=tool,container.find(".wb-tool").removeClass("active"),$(this).addClass("active"),"text"===tool?(container.find(".wb-stroke-sizes").hide(),container.find(".wb-stamp-settings").hide(),container.find(".wb-text-settings").show()):"stamp"===tool?(container.find(".wb-stroke-sizes").hide(),container.find(".wb-text-settings").hide(),container.find(".wb-stamp-settings").css("display","flex")):(container.find(".wb-text-settings").hide(),container.find(".wb-stamp-settings").hide(),container.find(".wb-stroke-sizes").show())})),container.find(".wb-size").click((function(){var size=$(this).data("size");board.strokeSize=size,container.find(".wb-size").removeClass("active"),$(this).addClass("active")}));var stampPaths={"check-circle":"M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628 0z","times-circle":"M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3 0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3 0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3 0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3 0 17L312 256l65.6 65.1z","exclamation-triangle":"M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-8.836 7.164-16 16-16h16c8.836 0 16 7.164 16 16v148c0 8.836-7.164 16-16 16h-16c-8.836 0-16-7.164-16-16V168zm24 272c-17.67 0-32-14.33-32-32s14.33-32 32-32 32 14.33 32 32-14.33 32-32 32z",lightbulb:"M355.2 331.1C339.4 345.2 320 357.7 320 384h-128c0-26.3-19.4-38.8-35.2-52.9C119.8 298.5 96 261 96 216c0-88.4 71.6-160 160-160s160 71.6 160 160c0 45-23.8 82.5-60.8 115.1zM256 512c26.5 0 48-21.5 48-48h-96c0 26.5 21.5 48 48 48zm64-112h-128c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h128c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16z",heart:"M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"},activeStamp="check-circle";container.find(".wb-stamp-pick").click((function(){activeStamp=$(this).data("stamp"),container.find(".wb-stamp-pick").removeClass("active"),$(this).addClass("active"),$activeStampBox&&updateStampSVG()})),container.find(".wb-color-box").click((function(){$(this).siblings(".wb-color-picker").click()})),container.find(".wb-stroke-clear").click((function(){board.strokeColor="transparent",container.find(".wb-stroke-color").css("background-color","transparent")})),container.find(".wb-fill-clear").click((function(){board.fillColor="transparent",container.find(".wb-fill-color").css("background-color","transparent")})),container.find(".wb-bg-clear").click((function(){board.bgColor="transparent",container.find(".wb-bg-color").css("background-color","transparent"),board.redraw()})),container.find(".wb-stroke-picker").on("input change",(function(){var color=$(this).val();board.strokeColor=color,container.find(".wb-stroke-color").css("background-color",color)})),container.find(".wb-fill-picker").on("input change",(function(){var color=$(this).val();board.fillColor=color,container.find(".wb-fill-color").css("background-color",color)})),container.find(".wb-bg-picker").on("input change",(function(){var color=$(this).val();board.bgColor=color,container.find(".wb-bg-color").css("background-color",color),board.redraw()})),container.find(".wb-sidebar-toggle").click((function(){container.find(".wb-sidebar").toggleClass("collapsed")})),container.find(".undo-whiteboard").click((function(){board.undo()})),container.find(".redo-whiteboard").click((function(){board.redo()})),container.find(".clear-whiteboard").click((function(){confirm(self.strings.confirmclearcanvas)&&board.clear()}));var baseWidth=container.data("width")||800,baseHeight=container.data("height")||600;$(board.canvas).on("wb:resized",(function(e,dims){baseWidth=dims.width,baseHeight=dims.height,updateZoom()}));var updateZoom=function(){$(board.canvas).css({transform:"scale("+board.zoom+")","transform-origin":"0 0"}),container.find(".assignsubmission_cloudpoodll_whiteboard").css({width:baseWidth*board.zoom+"px",height:baseHeight*board.zoom+"px"})};container.find(".zoom-in").click((function(){board.zoom+=.1,updateZoom()})),container.find(".zoom-out").click((function(){board.zoom>.5&&(board.zoom-=.1,updateZoom())}));var $activeTextBox=null,commitText=function(){if($activeTextBox){var text=$activeTextBox.find("textarea").val();if(""!==text.trim()){var pos=$activeTextBox.position(),step={type:"text",text:text,points:[{x:pos.left/board.zoom,y:pos.top/board.zoom}],width:Math.max(10,($activeTextBox.width()-8)/board.zoom),strokeColor:board.strokeColor,fillColor:board.fillColor,strokeSize:board.strokeSize,fontFamily:container.find(".wb-text-font").val(),fontSize:parseInt(container.find(".wb-text-size").val()),isBold:container.find(".wb-text-bold").is(":checked"),isItalic:container.find(".wb-text-italic").is(":checked")};board.addStep(step),board.redraw()}$activeTextBox.remove(),$activeTextBox=null}},$activeStampBox=null,commitStamp=function(){if($activeStampBox){var pos=$activeStampBox.position(),x=pos.left/board.zoom,y=pos.top/board.zoom,width=$activeStampBox.width()/board.zoom,height=$activeStampBox.height()/board.zoom,step={type:"stamp",stamp:$activeStampBox.data("stamp"),paths:stampPaths,points:[{x:x,y:y}],width:width,height:height,strokeColor:board.strokeColor};board.addStep(step),board.redraw(),$activeStampBox.remove(),$activeStampBox=null}},updateStampSVG=function(){$activeStampBox&&(activeStamp=container.find(".wb-stamp-pick.active").data("stamp"),$activeStampBox.data("stamp",activeStamp),$activeStampBox.find("path").attr("d",stampPaths[activeStamp]),$activeStampBox.find("path").attr("fill",board.strokeColor))};container.find(".wb-stroke-picker").on("input change",(function(){updateStampSVG()})),container.find(".wb-stroke-clear").click((function(){setTimeout(updateStampSVG,10)}));$(board.canvas).on("mousedown touchstart",(function(e){var rect=board.canvas.getBoundingClientRect(),touch=e.originalEvent.touches?e.originalEvent.touches[0]:e,clientX=touch.clientX,clientY=touch.clientY,isInside=clientX>=rect.left&&clientX<=rect.right&&clientY>=rect.top&&clientY<=rect.bottom;if("text"===board.tool){if(commitStamp(),$activeTextBox&&$activeTextBox.hasClass("selected"))commitText();else if(!$activeTextBox&&isInside){!function(x,y){commitText();var $overlay=$('<div class="wb-text-overlay editing"></div>'),$textarea=$('<textarea spellcheck="false"></textarea>'),updateStyles=function(){var fontFamily=container.find(".wb-text-font").val(),fontSize=container.find(".wb-text-size").val()+"px",isBold=container.find(".wb-text-bold").is(":checked"),isItalic=container.find(".wb-text-italic").is(":checked");$textarea.css({"font-family":fontFamily,"font-size":fontSize,"font-weight":isBold?"bold":"normal","font-style":isItalic?"italic":"normal",color:board.strokeColor})};updateStyles(),container.find(".wb-text-settings input, .wb-text-settings select, .wb-stroke-picker").off("change.wblive").on("change.wblive",updateStyles),$overlay.append($textarea),$overlay.css({left:x*board.zoom,top:y*board.zoom});var dragStartX,dragStartY,initialLeft,initialTop,isDragging=!1;$overlay.on("mousedown touchstart",(function(e){if($overlay.hasClass("selected")){isDragging=!0;var touch=e.originalEvent.touches?e.originalEvent.touches[0]:e;dragStartX=touch.pageX,dragStartY=touch.pageY;var pos=$overlay.position();initialLeft=pos.left,initialTop=pos.top,e.stopPropagation()}})),$(document).on("mousemove.wbtextdrag touchmove.wbtextdrag",(function(e){if(isDragging){var touch=e.originalEvent.touches?e.originalEvent.touches[0]:e,dx=touch.pageX-dragStartX,dy=touch.pageY-dragStartY,newLeft=initialLeft+dx,newTop=initialTop+dy,maxLeft=board.canvas.width*board.zoom-$overlay.outerWidth(),maxTop=board.canvas.height*board.zoom-$overlay.outerHeight();newLeft=Math.max(0,Math.min(newLeft,maxLeft)),newTop=Math.max(0,Math.min(newTop,maxTop)),$overlay.css({left:newLeft,top:newTop})}})),$(document).on("mouseup.wbtextdrag touchend.wbtextdrag",(function(e){isDragging=!1})),$textarea.on("blur",(function(){$overlay.removeClass("editing").addClass("selected")})),$overlay.on("click",(function(e){$overlay.hasClass("selected")&&($overlay.removeClass("selected").addClass("editing"),$textarea.focus(),e.stopPropagation())})),container.find(".assignsubmission_cloudpoodll_whiteboard").append($overlay),$textarea.focus(),$activeTextBox=$overlay}((clientX-rect.left)/board.zoom,(clientY-rect.top)/board.zoom)}}else if("stamp"===board.tool){if(commitText(),$activeStampBox)commitStamp();else if(isInside){!function(x,y){commitStamp(),activeStamp=container.find(".wb-stamp-pick.active").data("stamp");var $overlay=$('<div class="wb-stamp-overlay"></div>'),$svg=$('<svg viewBox="0 0 512 512"><path d="'+stampPaths[activeStamp]+'" fill="'+board.strokeColor+'"/></svg>'),$resizeHandle=$('<div class="wb-stamp-resize"></div>');$overlay.data("stamp",activeStamp),$overlay.append($svg).append($resizeHandle),$overlay.css({left:x*board.zoom-100*board.zoom/2,top:y*board.zoom-100*board.zoom/2,width:100*board.zoom,height:100*board.zoom});var dragStartX,dragStartY,initialLeft,initialTop,initialWidth,isDragging=!1,isResizing=!1;$overlay.on("mousedown touchstart",(function(e){var target=$(e.target),touch=e.originalEvent.touches?e.originalEvent.touches[0]:e;dragStartX=touch.pageX,dragStartY=touch.pageY;var pos=$overlay.position();initialLeft=pos.left,initialTop=pos.top,initialWidth=$overlay.width(),$overlay.height(),target.hasClass("wb-stamp-resize")?isResizing=!0:isDragging=!0,e.stopPropagation(),e.preventDefault()})),$(document).on("mousemove.wbstampdrag touchmove.wbstampdrag",(function(e){if(isDragging||isResizing){var touch=e.originalEvent.touches?e.originalEvent.touches[0]:e;if(isDragging){var dx=touch.pageX-dragStartX,dy=touch.pageY-dragStartY;$overlay.css({left:initialLeft+dx,top:initialTop+dy})}else if(isResizing){dx=touch.pageX-dragStartX;var newSize=Math.max(20*board.zoom,initialWidth+dx);$overlay.css({width:newSize,height:newSize})}}})),$(document).on("mouseup.wbstampdrag touchend.wbstampdrag",(function(e){isDragging=!1,isResizing=!1})),container.find(".assignsubmission_cloudpoodll_whiteboard").append($overlay),$activeStampBox=$overlay}((clientX-rect.left)/board.zoom,(clientY-rect.top)/board.zoom)}}else commitText(),commitStamp()})),container.find(".wb-tool").click((function(){commitText(),commitStamp()})),$(board.canvas).on("wb:colorpicked",(function(e,hex){board.strokeColor=hex,container.find(".wb-stroke-color").css("background-color",hex),container.find(".wb-stroke-picker").val(hex),container.find('[data-tool="pencil"]').click()}));var saveTimer=null,performSave=function(){var btn=container.find(".save-whiteboard");if(!btn.prop("disabled")){var vectorData=board.getVectorData(),imageData=board.getImageData(),vectorControl=$("#"+container.data("vectorcontrol")),updateControl=$("#"+container.data("updatecontrol")),draftitemid=container.data("draftitemid");btn.text(self.strings.saving).prop("disabled",!0),Ajax.call([{methodname:"assignsubmission_cloudpoodll_upload_whiteboard_image",args:{base64data:imageData,draftitemid:draftitemid,filename:"img"+draftitemid+".jpg"}}])[0].then((function(filename){return vectorControl.val(vectorData),updateControl.val(filename),btn.text(self.strings.saved),updateControl.trigger("change"),filename})).catch((function(e){btn.text(self.strings.save).prop("disabled",!1),Notification.exception(e)}))}};container.find(".save-whiteboard").click((function(){saveTimer&&clearTimeout(saveTimer),performSave()})),$(board.canvas).on("wb:changed",(function(){container.find(".save-whiteboard").text(self.strings.save).prop("disabled",!1),saveTimer&&clearTimeout(saveTimer),saveTimer=setTimeout((function(){performSave()}),1e3)}));var vectorControlId=container.data("vectorcontrol");if(vectorControlId){var existingJson=$("#"+vectorControlId).val();existingJson&&board.loadVectorData(existingJson)}}}}));

//# sourceMappingURL=whiteboard.min.js.map